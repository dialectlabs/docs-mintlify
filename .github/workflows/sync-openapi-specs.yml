name: Sync OpenAPI Specs

on:
  schedule:
    - cron: '0 9 * * *' # Daily at 9 AM UTC
  workflow_dispatch: # Also manually triggerable

jobs:
  sync:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write

    steps:
      - uses: actions/checkout@v4

      - name: Fetch specs
        run: |
          declare -A SPECS=(
            [openapi/lulo.json]="https://lulo-blinks-preview.dialect.workers.dev/api/openapi.json"
          )

          for file in "${!SPECS[@]}"; do
            url="${SPECS[$file]}"
            echo "Fetching $url"
            if curl -sf --max-time 30 "$url" | jq '.' > "${file}.tmp"; then
              mv "${file}.tmp" "$file"
              echo "✓ $file updated"
            else
              rm -f "${file}.tmp"
              echo "✗ Failed to fetch $url — keeping existing file"
            fi
          done

      - name: Compute PR metadata
        id: pr
        run: |
          protocols=$(git diff --name-only | grep '^openapi/' | sed 's|openapi/||;s|\.json||' | tr '\n' ' ' | xargs | tr ' ' ',')
          if [ -z "$protocols" ]; then
            echo "No changes detected"
            exit 0
          fi

          count=$(echo "$protocols" | tr ',' '\n' | grep -c .)
          readable=$(echo "$protocols" | tr ',' '\n' | paste -sd ', ')

          if [ "$count" -eq 1 ]; then
            echo "title=chore: update openapi spec for $readable" >> $GITHUB_OUTPUT
          else
            echo "title=chore: update openapi specs for $readable" >> $GITHUB_OUTPUT
          fi

      - name: Open PR if anything changed
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "${{ steps.pr.outputs.title }}"
          branch: chore/sync-openapi-specs
          delete-branch: true
          title: "${{ steps.pr.outputs.title }}"
          body: |
            Automated daily sync of OpenAPI specs from live APIs.

            Review the diff and merge when ready — Mintlify will rebuild automatically.
          labels: automated
